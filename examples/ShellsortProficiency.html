<!DOCTYPE html>
<html>
<head>
<title>ShellSort Proficiency Exercise</title>
<link href="AeBookAV.css" title="CSS" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="../css/JSAV.css" type="text/css" />
<style>

#container {
  width: 800px;
  height: 435px;
  border: 1px solid black;
  background-color: #efe;
  padding: 10px;
  overflow: hidden;
}

#container .jsavarray {
   left: -10px;
   height: 80px;
}

div h1 {
  background-color: #efe;
}
.jsavcontainer {
  background-color: #efe;
}

  p.jsavoutput.jsavline {
    height: 40px;
    border: 1px;
  }
a.jsavsettings {
display: block;
margin-top: 10px;
margin-left: 10px;
}

</style>
</head>

<body>
<div id="container">
<table id=tableT style="margin-top: -20px">
  <tr>
  <td width=125px>&nbsp;</td>
  <td width=550px align="center">
    <p align="center" class="jsavexercisecontrols"></p>
  </td>
  <td width=125px align="right">
    <p align="right">
      <input type="button" name="help" value="Help" />
      <input type="button" name="about" value="About" />
      <a class="jsavsettings" href="#">Settings</a>
    </p>
  </td>
  </tr>
</table>
<form style="border: 0px" id="ssproficiency">
  <p style="margin-top:-5px">Instructions:</p>
  <p style="margin-top: -15px; padding: 10px; 10px; margin-right: 10px; border: 1px solid black">
     For each increment, you will need to process each
     sublist in turn. For each sublist, click on its entries in the
     Input array to highlight them. Once you have the sublist
     selected, click "Done Selecting". Next, drag and drop the items
     to sort them. Then click "Done Sorting Sublist" to go on to the next
     sublist. When you have processed all of the sublists for a given
     increment, click "Done Increment".
  </p>

  Increments to use: <input type="text" readonly="readonly" name="incrField" id="incrField" width="50">

  <p><b>Input:</b></p>

  <ol id="profArray" style="margin-top: -15px; margin-bottom: 40px"></ol>

  <input type="button" name="selecting" value="Done Selecting" />
  <input type="button" name="sorting" value="Done Sorting Sublist" />
  <input type="button" name="incrementing" value="Done Increment" />

  <p class="jsavoutput jsavline"></p>
</form>
</div> <!-- container -->

<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js">
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"></script>
<script src="../lib/jquery.transform.light.js"></script>

<script src="../build/JSAV.js"></script>


<script>
//(function($) {
  /* **************************************************************
  *  This first section is generic initialization that all AVs    *
  *  will need, including initialization for the OpenDSA library  *
  *  The first line you need to set to use your form's name       *
  ************************************************************** */
  // Define the local context (from form name)
  var context = $("#ssproficiency");
  //containing HTML element with id ssproficiency.
  var av = new JSAV(context);

  var settings = new JSAV.utils.Settings($(".jsavsettings"));
  // add the layout setting preference
  var arrayLayout = settings.add("layout", {"type": "select", "options": {"bar": "Bar", "array": "Array"}, "label":"Array layout: ", "value": "array"});
  var feedback = settings.add("feedbck", {"type": "select", "options": {"continuous": "Continuous", "atend": "At end"}, "label":"Grade Feedback: ", "value": "At end"});

  av.recorded();
  // Set up an output message buffer object,
  // and create a convenience function named Tell
  var Tell = function(msg, color) { av.umsg(msg, {color: color}); };
  var ArraySize = 10; // Size of the exercise array

  /* **************************************************************
  *        Everything below this is specific to this AV           *
  ************************************************************** */

  /* **************************************************************
  *  This section connects the action callbacks to the            *
  *  form entities.                                               *
  ************************************************************** */
  $('input[name="help"]').click(help);
  $('input[name="about"]').click(about);

  var $selecting = $('input[name="selecting"]', context).click(selecting),
      $sorting = $('input[name="sorting"]', context).click(sorting),
      $incrementing = $('input[name="incrementing"]', context).click(incrementing);

  var incrs = [], // The array of increments
      $theArray = $("#profArray"),
      initialArray = [], // needed for model answer
      theArray,
      mode = "SELECTING",
      currIncrIndex, // The index for the student's current increment
      currSublist = 0, // the current sublist number
      currStep = 0; // for step-by-step grading
    
  // Partial Shellsort. Sweep with the given increment
  function sweep(incr, arr, jsav) {
    var j = 0,
        numElem = 0,
        highlightFunction = function(index) { return index%incr == j;};
    for (j=0; j<incr; j++) {         // Sort each sublist
      // Highlight the sublist
      numElem = Math.ceil(arr.size()/incr);
      if(j+(incr*(numElem-1))>=arr.size()) numElem = numElem-1;
      if (numElem == 1) {
        return;
      } else {
        arr.highlight(highlightFunction);
        jsav.step();
        jsav.setStepOption("grade", true);
      }
      inssort(j, incr, arr, jsav);
      arr.unhighlight(highlightFunction);
      jsav.step();
      jsav.setStepOption("grade", true);
    }
  }

  // Insertion sort using increments
  function inssort(start, incr, arr, jsav) {
    var i, j;
    for (i=start+incr; i<arr.size(); i+=incr) {
      for (j=i; j>=incr; j-=incr) {
        if (parseInt(arr.value(j), 10) < parseInt(arr.value(j-incr), 10)) {
          arr.swap(j, j-incr); // swap the two indices
          jsav.step();
        } else {
          break; // Done pushing element, leave for loop
        }
      }
    }
  }

  // generates the model answer; calls sweep above
  function shellsort(jsav) {
    var modelarr = jsav.ds.array(initialArray, {indexed: true, layout: arrayLayout.val()});
    var i;
    for (i=0; i<incrs.length; i+=1) {
      if (incrs[i] < modelarr.size()) {
        sweep(incrs[i], modelarr, jsav); // run the sweep to create the AV
      }
      modelarr.unhighlight();
      jsav.step();
      jsav.setStepOption("grade", true);      
    }
    return modelarr;
  }
    
  // Generate a random (but constrained) set of four increments
  // (tuned for an array size of 10)
  function generateIncrements() {
    incrs[0] = Math.floor(Math.random()*3) + 6; // incrs[0]: 6 to 8
    incrs[2] = Math.floor(Math.random()*3) + 2; // incrs[2]: 2 to 4
    // incrs[1] is something between incrs[0] and incrs[2]
    incrs[1] = Math.floor(Math.random()*(incrs[0]-incrs[2]-1)) + incrs[2] + 1;
    incrs[3] = 1; // Always end in 1
  }
  
  // Process reset button: Re-initialize everything, including the increments
  function initialize() {
console.log("Feedback:" + feedback.val());
    generateIncrements();
    document.forms['ssproficiency'].elements['incrField'].value = incrs;
  
    htmldata = "";
    for (var i=ArraySize; i>0; i--) {
      var randomVal = Math.floor(Math.random()*100);
      htmldata += "<li>" + randomVal + "</li>";
      initialArray[ArraySize-i] = randomVal;
    }
    $theArray.html(htmldata);

    theArray = av.ds.array($theArray, {indexed: true, layout: arrayLayout.val()});
    currIncrIndex = 0;
    currSublist = 0;
    currStep = 0;
    mode = "SELECTING",
    Tell("To start the exercise: Click on array elements to highlight those that make up the first sublist. Use increment " + incrs[currIncrIndex]);
    av.forward();
    return theArray;
  }

  // Process help button: Give a full help page for this activity
  // We might give them another HTML page to look at.
  function help() {
    myRef = window.open("http://algoviz.org/OpenDSA/trunk/AV/SSprofHelp.html", 'helpwindow');
  }

  // Process about button: Pop up a message with an Alert
  function about() {
    var mystring = "Shellsort Proficiency Exercise\nWritten by Cliff Shaffer and Ville Karavirta\nCreated as part of the OpenDSA hypertextbook project.\nFor more information, see http://algoviz.org/eBook\nWritten during August, 2011\nLast update: August 6, 2011\nJSAV library version " + JSAV.version();
    alert(mystring);
  }

  // Process Done selecting button: change the message, array status
  function selecting() {
    mode = "SORTING";
    av.setStepOption("grade", true);
    Tell("Click on two array elements to swap them. Swap elements in the sublist until it is sorted.");
    av.forward();
    console.log(++currStep, exer.grade().correct, (exer.grade().correct === currStep)?"CORRECT":"INCORRECT");
  }

  // Process Done sorting Sublist button: change the message, array status
  function sorting() {
    mode = "SELECTING";
    Tell("Click on array elements to highlight those that make up the next sublist. If you have already sorted the last sublist for this increment, then click the 'Done Increment' button. Do not bother to process sublists with only one element.");
    theArray.unhighlight();
    if (currSublist > 0) {
      theArray.toggleArrow(currSublist);
    }
    theArray.toggleArrow(++currSublist);
    
    av.forward();
    av.setStepOption("grade", true);
    console.log(++currStep, exer.grade().correct, (exer.grade().correct === currStep)?"CORRECT":"INCORRECT");
  }

  // Process Done Increment button: change the message, array status
  function incrementing() {
    if (currIncrIndex < 3) {
      theArray.unhighlight();
      /*if (mode === "SORTING") { // so student is not forced to click sorted
        av.setStepOption("grade", true);
      }*/
      currIncrIndex++;
      theArray.toggleArrow(currSublist);
      currSublist = 0;
      
      Tell("Click on array elements to highlight those that make up the first sublist. Use increment " + incrs[currIncrIndex]);
    } else {
      Tell("Exercise is done, check your grade.");
    }
    av.forward();
    av.setStepOption("grade", true);
    console.log(++currStep, exer.grade().correct, (exer.grade().correct === currStep)?"CORRECT":"INCORRECT");
    mode = "SELECTING";
  }

  // Initialize the exercise
  // Defines the function to call on reset (initialize()), and the
  //  function to call to generate the model answer (shellsort())
  var exer = av.exercise({reset: initialize,
                          model: shellsort,
                          compare: {css: "background-color"},
                          controls: $('.jsavexercisecontrols')});
  exer.reset();
  
  var swapIndex = null;
  // register click handlers for the array indices
  $("#profArray .jsavindex").live("click", function() {
    var index = $(this).parent(".jsavarray").find(".jsavindex").index(this);
    if (mode === "SELECTING") { // in selecting mode, highlight index
      if (theArray.css(index, "background-color") === "rgb(255, 255, 255)") {
        theArray.highlight(index);
      } else {
        theArray.unhighlight(index);
      }
      av.step();
    } else if (mode === "SORTING") { // in sorting mode
      if (!swapIndex && swapIndex !== 0) { // if first click
        theArray.css(index, {"font-size": "130%"});
        swapIndex = index;
        av.forward();
      } else { // second click will swap
        av._redo = []; // clear the forward stack, should add a method for this in lib
        theArray.swap(swapIndex, index, {});
        theArray.css([swapIndex, index], {"font-size": "100%"});
        av.forward();
        swapIndex = null;
      }
    }
  });
//})(jQuery);
</script>
</body>
</html>
