<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>ShellSort AV</title>
<link href="AeBookAV.css" title="CSS" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="../css/JSAV.css" type="text/css" />
<style>

#container {
  width: 770px;
  height: 465px;
  border: 1px solid black;
  background-color: #efe;
  padding: 10px;
  overflow: hidden;
}

div h1 {
  background-color: #efe;
}
.jsavcontainer {
  background-color: #efe;
  border: none;
}
.array {
  padding-left:0;
}
p.output.line {
  height: 30px;
}

</style>
</head>

<body>
<div id="container">
  <input type="button" name="about" value="About" />
  <h1 style="margin:-25px 0px 0px 0px">Shellsort Visualization</h1>

  <form id="ssperform">
    <p><label for="increments">Increments: Type your increment
                               series below.</label></p>
    <input size="50" name="increments" type="text"
           placeholder="Space separated values, for example 8 4 2 1" />
    <p>
      <input type="button" name="run" value="Run" />
      <input type="button" name="clear" value="Clear" />
      <label for="arraysize">&nbsp;List size:&nbsp;</label>
      <select id="arraysize">
        <option value = 5>5</option>
        <option value = 6>6</option>
        <option value = 7>7</option>
        <option selected value = 8>8</option>
        <option value = 9>9</option>
        <option value = 10>10</option>
        <option value = 11>11</option>
        <option value = 12>12</option>
        <option value = 13>13</option>
        <option value = 14>14</option>
        <option value = 15>15</option>
        <option value = 16>16</option>
      </select>
      <input type="button" name="pick" id="pick" value="Pick Values" />
      <input size="60" name="arrayValues" id="arrayValues" type="text" disabled="disabled" />
    </p>
  </form>
  <div id="avcontainer">
    <table id=tableT style="margin-top:-15px; margin-bottom:-15px">
    <tr>
      <td width=100><span class="counter"></span></td>
      <td width=520px>
        <div class="controls"></div>
      </td>
    </tr>
    </table>
    <p class="output line" readonly="readonly"></p>
  </div> <!--avcontainer-->
</div> <!--container-->

<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js">
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"></script>
<script src="../lib/jquery.transform.light.js"></script>

<script src="../build/JSAV-min.js"></script>

<script>
(function($) {
  // State variables
  var picking = false; // True iff the user is currently picking values
  var changeArrayVals = true; // True iff array values should be replaced on "Run"
  // Number of values in the array
  var ASize = document.getElementById('arraysize').selectedIndex + 5;
  var theArray = [];  // The array of numbers.

  // check query parameters from URL
  var params = JSAV.utils.getQueryParameter();
  if ("increments" in params) { // set value of increments if it is a param
    $('input[name="increments"]').val(params["increments"]).prop("disabled", true);
  }
  if ("array" in params) { // set value of array pick if it is a param
    $('#arrayValues').val(params["array"]).prop("disabled", true);
    // TODO: Put the array values into theArray
    changeArrayVals = false; // We don't want to change the values again
  }
  var context = $("#ssperform");

  var emptyContent = $("#avcontainer").html();

  var av, // for JSAV av
    arr;  // for the JSAV array


  /* **************************************************************
  *  This section connects the action callbacks to the            *
  *  form entities.                                               *
  ************************************************************** */
  $('input[name="about"]').click(about);
  $('input[name="run"]', context).click(runIt);
  $('input[name="clear"]', context).click(clear);
  $('input[name="increments"]', context).focusout(checkIncrements);
  $('input[name="pick"]', context).click(pickIt);

  // Process Pick button: Enable/disable text field
  function pickIt() {
    if (picking) { // Stop picking
      picking = false; // toggle
      document.getElementById("arrayValues").disabled = true;
      document.getElementById("pick").value = "Pick Values";
      processArrayValues();
    }
    else { // picking === false, so start picking
      if ("array" in params) return; // Do nothing
      picking = true; // toggle
      document.getElementById("arrayValues").disabled = false;
      document.getElementById("pick").value = "Accept Values";
    }
  }

  // Process About button: Pop up a message with an Alert
  function about() {
    var mystring = "Shellsort Algorithm Visualization\nWritten by Cliff Shaffer and Ville Karavirta\nCreated as part of the OpenDSA hypertextbook project.\nFor more information, see http://algoviz.org/eBook\nWritten during August, 2011\nLast update: August 10, 2011\nJSAV library version " + JSAV.version();
    alert(mystring);
  }

  // Process clear button: Clear the output textbox and the AV
  function clear() {
    if (av) {
      av.clearumsg();
      $("#avcontainer").unbind().html(emptyContent);
    }

    // Clean up picking activity
    picking = false; // toggle
    document.getElementById("arrayValues").disabled = true;
    document.getElementById("pick").value = "Pick Values";
  }

  // Validate the increment series
  // TODO: It is annoying that extra spaces come up as null numbers,
  // causing validation to fail
  function checkIncrements() {
    var i, 
      num, 
      prev = Number.MAX_VALUE, 
      msg = "Increments sequence must be decreasing positive values ending with 1";
    // Convert user's increments to an array,
    // assuming values are space separated
    var incrs = $('input[name="increments"]', context).val().split(' ');
    for (i=0; i<incrs.length; i++) {
      incrs[i] = Number(incrs[i]);
      if (isNaN(incrs[i]) || incrs[i] < 0 || incrs[i] > prev) { 
        alert(msg);
        return null; 
      }
      prev = incrs[i];
    }
    if (incrs[incrs.length - 1] !== 1) { 
      alert(msg);
      return null; 
    }
    return incrs;
  }

  // Validate the user-defined array values
  // TODO: It is annoying that extra spaces come up as null numbers,
  // causing validation to fail
  function processArrayValues() {
    var i, 
      num, 
    msg = "There must be " + ASize + " positive numeric values";
    // Convert user's increments to an array,
    // assuming values are space separated
    theArray = $('input[name="arrayValues"]', context).val().split(' ');
    if (theArray.length !== ASize) {
      alert(msg);
      return null;
    }
    for (i=0; i<theArray.length; i++) {
      theArray[i] = Number(theArray[i]);
      if (isNaN(theArray[i]) || theArray[i] < 0) { 
        alert(msg);
        return null; 
      }
    }
    changeArrayVals = false; // Don't want them changing again!
  }


  var setBlue = function(index) {
    arr.css(index, {"background-color": "#ddf" });
  };

  // Partial Shellsort. Sweep with the given increment
  function sweep(incr) {
    var j = 0;
    var numElem = 0;
    av.umsg("Start the next increment size: " + incr);
    av.step();
    highlightFunction = function(index) { return index%incr == j;};
    for (j=0; j<incr; j++) {         // Sort each sublist
      // Highlight the sublist
      arr.highlight(highlightFunction);
      numElem = Math.ceil(theArray.length/incr);
      if(j+(incr*(numElem-1))>=theArray.length) numElem = numElem-1;
      if (numElem == 1) {
        av.umsg("Since the rest of the subarrays for this increment are of length 1, we will skip them");
        av.step();
        arr.unhighlight(highlightFunction);
        return;
      }
      av.umsg("Starting to sort a new subarray with " + numElem + " elements");
      av.step();
      inssort(j, incr);
      arr.unhighlight(highlightFunction);
    }
  }

  // Insertion sort using increments
  function inssort(start, incr) {
    var i, j;
av.umsg("Sorting the subarray");
    for (i=start+incr; i<arr.size(); i+=incr) {
      setBlue(i);
      av.step();
      for (j=i; j>=incr && (arr.value(j) < arr.value(j-incr)); j-=incr) {
        arr.swap(j, j-incr); // swap the two indices
        av.step();
        setBlue(j-incr);
	arr.highlight(j);
        av.step();
      }
      arr.highlight(j);
    }
  }
  
  // Execute the "Run" button function
  function runIt() {
    var i;
    var newSize = document.getElementById('arraysize').selectedIndex + 5;

    // Validate the user's increments
    var incrs = checkIncrements();
    if (!incrs) {
      return;
    }

    if (newSize !== ASize) changeArrayVals = true;
    if (changeArrayVals) {
      ASize = newSize;
      theArray.length = 0; // Out with the old
      // Give random numbers in range 0..999
      for (i=0; i < ASize; i++) {
        theArray[i] = Math.floor(Math.random()*1000);
      }
    }
    clear(); // clear any previous visualization
    av = new JSAV("avcontainer"); // initialize JSAV ..
    arr = av.ds.array(theArray, {indexed: true, layout: "bar"}); // .. and the array
    var i, incr;
    for (i=0; i<incrs.length; i+=1) {
      if (incrs[i] < theArray.length) {
        sweep(incrs[i]); // run the sweep to create the AV
      }
    }
    av.recorded(); // mark the end
  }
})(jQuery);
</script>
</body>
</html>
